Mediasite.namespace("Player"),Mediasite.Player.Model=function(n){function checkCurrentChapter(n){var t=vt.GetChapterAt(n);if(typeof t=="undefined"||t.Number<1){if(n===0)return;t=new Mediasite.Chapter(0,0,"")}it!==t.Time&&(it=t.Time,i.fire(r.ChapterChange,t))}function checkCurrentTimedEvent(n){var t=c.GetTimedEvents(n);s.each(t,function(n,t){i.fire(r.TimedEventReached,t)})}function checkCurrentCaption(n){if(!t.DisableCaptionDisplay){var u=vt.GetCaptionAt(n);typeof u!="undefined"&&u.Text!==yt&&(yt=u.Text,i.fire(r.CaptionChange,u))}}function checkPauseState(n){var u=ot.GetCurrentItem(n);typeof u!="undefined"&&u.Paused!==tt&&(tt=u.Paused,t.PlayStatus=tt?Mediasite.Player.PresentationStatus.LivePaused:Mediasite.Player.PresentationStatus.Live,i.fire(r.LiveStatusChanged,t.PlayStatus))}function getLiveEvents(o){function successCallback(n){var i=[],r,t;for(s=0;s<n.d.length;s++){a=Math.max(a,n.d[s].Time);switch(n.d[s].EventType){case Mediasite.Player.TimelineEvent.PresentationEnd:u.Debug("Received PresentationEnd"),e=n.d[s].Time,w==Mediasite.Player.MediaState.Playing?(r=Math.max(0,e-l),u.Debug("PresentationEnd in "+r/1e3+" seconds."),window.setTimeout(PerformEndPresentation,r)):PerformEndPresentation();break;case Mediasite.Player.TimelineEvent.Slide:hasSlides()&&(t=new Mediasite.Slide(n.d[s].Sequence,n.d[s].Time,"",""),t.SetUrlProvider(f.SlideUrlProvider),t.StreamType=f.StreamType,f.LiveSlideQueue.push(t));break;case Mediasite.Player.TimelineEvent.PauseStart:d.push({Time:n.d[s].Time,Paused:!0});break;case Mediasite.Player.TimelineEvent.PauseEnd:d.push({Time:n.d[s].Time,Paused:!1});break;case Mediasite.Player.TimelineEvent.TimedEvent:i.push({Id:n.d[s].Id,Text:n.d[s].Payload,Time:n.d[s].Time,Type:n.d[s].PayloadType})}}i.length>0&&c.AddTimedEvents(i),o&&o(!0)}function errorCallback(n){var t=JSON.parse(n.responseText);t&&t.FaultType===Mediasite.Player.PlayerServiceFaultType.InvalidTicket?i.fire(r.InactivityExceeded):o&&o(!1)}var s;return t.PlayStatus===Mediasite.Player.PresentationStatus.Live||t.PlayStatus===Mediasite.Player.PresentationStatus.LivePaused?(n.GetLiveEvents(JSON.stringify({playbackTicket:t.PlaybackTicketId,sinceTimeInMs:a,currentTimeInMs:Math.floor(l+dt)}),successCallback,errorCallback),!0):!1}function pingServerTimerCallback(){var n=function(){p=setTimeout(pingServerTimerCallback,lt)};getLiveEvents(n)}function pollForLiveStartTimerCallback(){var r=function(n){pollForLiveStartCallbackSuccess(n)},i=function(){h=setTimeout(pollForLiveStartTimerCallback,nt)};n.GetLiveStatus(JSON.stringify({playbackTicket:t.PlaybackTicketId,presentationId:t.PresentationId}),r,i)}function pollForLiveStartCallbackSuccess(n){t.PlayStatus=n.d.PlayStatus;switch(t.PlayStatus){case Mediasite.Player.PresentationStatus.ScheduledForLive:i.fire(r.LiveStatusChanged,t.PlayStatus),h=setTimeout(pollForLiveStartTimerCallback,nt);break;case Mediasite.Player.PresentationStatus.OpenForLive:i.fire(r.LiveStatusChanged,t.PlayStatus),h=setTimeout(pollForLiveStartTimerCallback,kt);break;case Mediasite.Player.PresentationStatus.Live:case Mediasite.Player.PresentationStatus.LivePaused:u.Debug("Delaying the transition from Waiting to Live by "+b+"ms"),window.setTimeout(function(){i.fire(r.LiveStatusChanged,t.PlayStatus);var f=new Date(n.d.LiveStartUnixTimeInMs+g);i.fire(r.SetLiveStartTime,f),u.Info("Live start time set",f),i.fire(r.StartMedia,[]),u.Info("Start media: ",[]),getLiveEvents()},b);break;case Mediasite.Player.PresentationStatus.LiveEnded:case Mediasite.Player.PresentationStatus.NotAvailable:i.fire(r.LiveStatusChanged,t.PlayStatus),PerformEndPresentation()}}function pollForLiveStart(n){clearTimeout(h),h=setTimeout(pollForLiveStartTimerCallback,n)}function startServerPing(){clearTimeout(p),clearTimeout(k),p=setTimeout(pingServerTimerCallback,lt)}function inactivityTimerCallback(){var n=+new Date;n-pt>wt?i.fire(r.InactivityExceeded):k=setTimeout(inactivityTimerCallback,at)}function stopServerPing(){clearTimeout(p),pt=+new Date,k=setTimeout(inactivityTimerCallback,at)}function detectAndHandleLiveJumpBack(n){var i=n<ut-gt&&t.PlayStatus!=Mediasite.Player.PresentationStatus.OnDemand;ut=n,i&&(u.Debug("Live position jumped back."),haveSeenPresentationEndEvent()?(u.Debug("We already have the PresentationEnd event, so end immediately."),PerformEndPresentation()):y||(u.Debug("We don't have the PresentationEnd event, so let's check with the server..."),y=!0,getLiveEvents(function(){y=!1,haveSeenPresentationEndEvent()?(u.Debug("Server says PresentationEnded. I've always liked that server."),PerformEndPresentation()):u.Debug("Server says it doesn't know anything about PresentationEnd. I've never trusted that server.")})))}function applyPosition(n){n!=l&&(l=n,checkCurrentCaption(n),checkPauseState(n),checkCurrentChapter(n),checkCurrentTimedEvent(n))}function checkServerForPresentationEndEvent(n,t){u.Debug("Checking the server for the Presentation Ended event. Delay = "+n),window.setTimeout(function(){getLiveEvents(function(){haveSeenPresentationEndEvent()?(u.Debug("The media element raised an exception at the end of a live presentation. liveEndTime = "+e),PerformEndPresentation()):t()})},n)}function haveSeenPresentationEndEvent(){return e>0}function hasSlides(){return f&&f.HasSlides()}function withoutAudioOnlyStreamTypes(n){for(var u,r,f=[],i=0;i<n.length;i+=1)u=n[i],r=t.GetStream(u),r&&!r.AudioOnly&&f.push(u);return f}function onlyUniqueStreamTypes(n){for(var r,i=[],t=0;t<n.length;t++)r=n[t],s.inArray(r,i)==-1&&i.push(r);return i}function onlyValidStreamTypes(n){for(var r,u=[],i=0;i<n.length;i+=1)r=n[i],t.GetStream(r)&&u.push(r);return u}function PerformEndPresentation(){ct||(t.PlayStatus=Mediasite.Player.PresentationStatus.LiveEnded,i.fire(r.LiveStatusChanged,Mediasite.Player.PresentationStatus.LiveEnded),ct=!0)}function startDetectingLiveStalled(){o||(o=new LivePlayStalledDetector(function(){return t.PlayStatus},function(){return et},function(){return l},function(){return e>0}),o.LiveStreamStalledErrorCallback=function(){o.Stop()},o.LiveStreamEndedCallback=function(){o.Stop(),PerformEndPresentation()},o.Start())}function LivePlayStalledDetector(n,t,i,r){function timer_tick(){var s=t(),l=s==Mediasite.Player.MediaState.Playing||s==Mediasite.Player.MediaState.Waiting,c=n(),y=c==Mediasite.Player.PresentationStatus.Live||c==Mediasite.Player.PresentationStatus.LivePaused,o;if(!y||!l){this.ticksStalled=0;return}o=i(),h==o?(f++,u.Debug("LivePlayStalledDetector.ticksStalled = "+f)):f=0,h=o,f>=a&&r()?(u.Debug("Exceeded ticksToTriggerEndCheck and the presentation end is near."),e.LiveStreamEndedCallback&&e.LiveStreamEndedCallback(),e.Stop()):f==v&&(u.Debug("Exceeded ticksToTriggerMediaError"),e.LiveStreamStalledErrorCallback&&e.LiveStreamStalledErrorCallback(),e.Stop())}var e=this,c=2e3,l=15e3,s=500,f=0,a=Math.ceil(c/s),v=Math.ceil(l/s),o,h=Number.MAX_VALUE;this.LiveStreamStalledErrorCallback=function(){u.Debug("default LiveStreamStalledErrorCallback")},this.LiveStreamEndedCallback=function(){u.Debug("default LiveStreamEndedCallback")},this.Start=function(){this.Stop(),o=window.setInterval(timer_tick,s)},this.Stop=function(){o&&window.clearInterval(o),h=Number.MAX_VALUE,f=0}}var s=jQuery,vt=this,t,f,ht,c,st,ot,d=[],it=0,ni=0,yt,w,et,l=0,tt=!1,v,h=null,kt=5e3,nt=15e3,lt=1e4,dt=6e4,p=null,ti=3e4,k=null,wt=12e5,at=1e3,pt=null,b=0,bt=!1,y=!1,gt=1e3,ut=0,ft=Mediasite.Player.PlayerState.NotReady,rt=[],e=-1,a=-1,g=0,ct=!1,o,u=Mediasite.Logging.LoggerFactory("PlayerModel"),i=new Mediasite.Player.EventBundle,r=Mediasite.Player.ModelEvent;this.AddEventHandler=function(n,t){i.addHandler(n,t)},this.Initialize=function(n){n.PresentationId!=undefined&&(t=n,f=t.GetStream(Mediasite.ContentStreamType.Slide),g=t.ServerClockSkew,document.title=t.Title,ht=new Mediasite.Player.TimingSearcher(t.Chapters),c=new Mediasite.Player.TimedEventRepository(t.TimedEvents),ot=new Mediasite.Player.TimingSearcher(d),st=new Mediasite.Player.TimingSearcher(t.Transcript))},this.LoadMedia=function(){switch(t.PlayStatus){case Mediasite.Player.PresentationStatus.OnDemand:i.fire(r.StartMedia,[]);break;case Mediasite.Player.PresentationStatus.Live:case Mediasite.Player.PresentationStatus.LivePaused:if(hasSlides()&&f.Slides.length&&(a=f.Slides[f.Slides.length-1].Time),i.fire(r.StartMedia,[]),i.fire(r.LiveStatusChanged,t.PlayStatus),t.LiveStartUnixTimeInMs){var n=new Date(t.LiveStartUnixTimeInMs+g);i.fire(r.SetLiveStartTime,n),u.Info("Live start time set",n)}break;case Mediasite.Player.PresentationStatus.ScheduledForLive:i.fire(r.LiveStatusChanged,t.PlayStatus),pollForLiveStart(nt);break;case Mediasite.Player.PresentationStatus.OpenForLive:i.fire(r.LiveStatusChanged,t.PlayStatus),pollForLiveStart(kt);break;case Mediasite.Player.PresentationStatus.LiveEnded:case Mediasite.Player.PresentationStatus.NotAvailable:i.fire(r.LiveStatusChanged,t.PlayStatus),PerformEndPresentation()}},this.GetStreamsMetadata=function(){var r=s.map(t.Streams,function(n){return n.StreamType}),i=s.map(r,t.GetStream.bind(t));return s.map(i,function(n){return{streamType:n.StreamType,audioOnly:n.AudioOnly,aspectRatio:n.AspectRatio}})},this.GetVisibleStreamTypes=function(){return rt},this.SetVisibleStreamTypes=function(n){n=onlyUniqueStreamTypes(n),n=onlyValidStreamTypes(n),n=withoutAudioOnlyStreamTypes(n),rt=n,i.fire(r.VisibleStreamsChanged,n)},this.GetLiveStatus=function(){return t.PlayStatus},this.UpdateMediaInfo=function(n){var u,r,i;if(n&&n.length){for(u=0;u<n.length;u+=1)r=n[u],i=t.GetStream(r.StreamType),i&&(i.AudioOnly=r.AudioOnly,i.AspectRatio=r.AspectRatio);this.SetVisibleStreamTypes(this.GetVisibleStreamTypes())}},this.UpdateMediaState=function(n){if(n!==w){switch(n){case Mediasite.Player.MediaState.Playing:w=n,startServerPing(),getLiveEvents(),startDetectingLiveStalled();break;case Mediasite.Player.MediaState.MediaEnded:case Mediasite.Player.MediaState.Paused:case Mediasite.Player.MediaState.Stopped:w=n,stopServerPing(),getLiveEvents()}et=n}},this.UpdatePlayerState=function(n){ft=n,i.fire(r.PlayerStateChanged,n)},this.GetPlayerState=function(){return ft},this.UpdateMediaVolume=function(t){n.UserPreferences.SetValue(Mediasite.Player.Options.Volume,t)},this.SetInactivityTimeout=function(n){wt=n},this.SetPreference=function(t,i){n.UserPreferences.SetValue(t,i)},this.TogglePreference=function(t){n.UserPreferences.ToggleValue(t)},this.GetChapterAt=function(n){return ht.GetCurrentItem(n)},this.GetChapters=function(){return t.Chapters},this.GetTimedEventAt=function(n){return c.TimingSearcher.GetCurrentItem(n)},this.GetTimedEvents=function(){return c.GetAllTimedEvents()},this.GetLinks=function(){return t.Links},this.GetPollsUri=function(){var n=t.PollingLocation,i,r;return n?n.indexOf("://")>0?n:(i=document.location.href.match("^https?://[.\\d\\w\\-]+(:\\d+)?/"),!i)?void 0:r=i[0]+n.substring(1):""},this.GetCaptionAt=function(n){return st.GetCurrentItem(n)},this.GetCaptions=function(){return t.Transcript},this.GetSlides=function(n){n=n!=undefined?n:Mediasite.ContentStreamType.Slide;var i=t.GetStream(n);return i.Slides},this.GetAllSlides=function(){function compareTime(n,t){return n.time-t.time}var n=[];return s.each(t.Streams,function(t,i){n=n.concat(i.Slides)}),n.sort(compareTime),n},this.GetSlideAt=function(n,i){i=i!=undefined?i:Mediasite.ContentStreamType.Slide;var u=t.GetStream(i),r=new Mediasite.Player.TimingSearcher(u.Slides);return r.GetCurrentItem(n)},this.UpdatePosition=function(n){if(e>0&&e<n){PerformEndPresentation();return}(bt&&detectAndHandleLiveJumpBack(n),y)||applyPosition(n)},this.FireEvent=function(n,t){i.fire(n,t)},this.HandleMediaEvent=function(n){if(n.Type==="MS5"&&n.Command==="HE('E')"){var i=t.PlayStatus==Mediasite.Player.PresentationStatus.Live||t.PlayStatus==Mediasite.Player.PresentationStatus.LivePaused;i&&PerformEndPresentation()}},this.HandleMediaError=function(n){if(t.PlayStatus==Mediasite.Player.PresentationStatus.LiveEnded||t.PlayStatus==Mediasite.Player.PresentationStatus.NotAvailable){u.Debug("The media element raised an exception after a transition to LiveEnded or NotAvailable."),PerformEndPresentation();return}var f=t.PlayStatus==Mediasite.Player.PresentationStatus.Live||t.PlayStatus==Mediasite.Player.PresentationStatus.LivePaused;if(!f){i.fire(r.MediaError,n);return}if(haveSeenPresentationEndEvent()){u.Debug("The media element raised an exception at the end of a live presentation. liveEndTime = "+e),PerformEndPresentation();return}checkServerForPresentationEndEvent(0,function(){var t=5.1*1e3;checkServerForPresentationEndEvent(t,function(){i.fire(r.MediaError,n)})})},this.GetEmailInvite=function(){function successCallback(n){v={Message:n.d.MessageBody,Subject:n.d.Subject,ToAddresses:n.d.ToAddresses,FromAddress:n.d.FromAddress,MailTo:n.d.MailTo,UseServerForSMTP:n.d.UseServerForSMTP},i.fire(r.EmailInviteLoaded,v)}function errorCallback(){i.fire(r.EmailInviteLoaded,{Subject:t.Title,Message:window.location.href})}typeof v!="undefined"?i.fire(r.EmailInviteLoaded,v):n.GetInvite(JSON.stringify({playbackTicketId:t.PlaybackTicketId}),successCallback,errorCallback)},this.SendEmail=function(f){function successCallback(n){i.fire(r.SendEmailComplete,n.d.Success,n.d.Message),u.Debug("Send email invite complete.","Success? "+n.d.Success)}function errorCallback(n){i.fire(r.SendEmailComplete,!1,Mediasite.Player.Localization.Common.AsyncCommunicationError+" - "+n.status+" "+n.statusText),u.Debug("Send email invite failed",n.status,n.statusText)}n.UserPreferences.SetValue(Mediasite.Player.Options.UserFromEmail,f.FromAddress),n.SendInvite(JSON.stringify({playbackTicketId:t.PlaybackTicketId,invite:f}),successCallback,errorCallback),u.Debug("Sending email")},this.SendQuestion=function(f){function successCallback(n){i.fire(r.SendQuestionComplete,n.d.Success,n.d.Message),u.Debug("Send question completed.  Successful? ",n.d.Success)}function errorCallback(n){i.fire(r.SendQuestionComplete,!1,Mediasite.Player.Localization.Common.AsyncCommunicationError+" - "+n.status+" "+n.statusText),u.Debug("Send question failed",n.status,n.statusText)}n.UserPreferences.SetValue(Mediasite.Player.Options.UserFromName,f.Submitter),n.UserPreferences.SetValue(Mediasite.Player.Options.UserFromEmail,f.SubmitterEmail),n.SendQuestion(JSON.stringify({playbackTicketId:t.PlaybackTicketId,question:f}),successCallback,errorCallback),u.Debug("Sending question")},this.EnableLiveJumpBackDetection=function(){bt=!0},this.EnableLiveStartDelay=function(n){b=n}},Mediasite.Player.PresentationContentSearch=function(n){function successCallback(n,t){$.isArray(n)&&n.length>0&&(n=n.sort(function(n,t){return n.Time-t.Time}),u(n,function(n,t){return n.Time==t.Time&&n.Type==t.Type},function(n,t){return n.Text=[n.Text,t.Text].join(" ... "),n})),i.fire(r.SearchComplete,t,n)}function errorCallback(){i.fire(r.SearchError)}function sanitize(n){return $.trim(n)}var i=new Mediasite.Player.EventBundle,r=Mediasite.Player.ModelEvent,u;this.AddEventHandler=function(n,t){i.addHandler(n,t)},this.search=function(t){t=sanitize(t),t.length==0?i.fire(r.SearchComplete,t,[]):n.Search(t,successCallback,errorCallback)},u=function(n,t,i){var r,u,f;if(!n||!n.length||!t||!i)return n;for(r=0;r+1<n.length;)u=n[r],f=n[r+1],t(u,f)?(u=i(u,f),n.splice(r,2,u)):r++;return n}}
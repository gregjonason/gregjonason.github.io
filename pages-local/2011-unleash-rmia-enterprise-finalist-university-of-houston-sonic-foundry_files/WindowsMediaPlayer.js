Mediasite.namespace("MediaPlayer"),Mediasite.namespace("MediaPlayer.Views"),Mediasite.MediaPlayer.ModelWindowsMedia=function(n){function rateCheckTimer_tick(){if(t&&t.settings&&t.settings.rate&&t.settings.rate!=o){var n=+new Date;if(n<tt+at){t.settings.rate=o;return}o=t.settings.rate,raisePlaybackRateChanged(o)}}function raisePlaybackRateChanged(n){var t={Min:l[0],Max:l[l.length-1],Current:Math.round(n*100)/100,Rates:f.extend([],l)};p.Debug("Playback rate now "+t.Current),r.fire(u.PlaybackRateChanged,t)}function getNextPlaybackRate(n,t){var u,r,e;return n=n!==!1,t=t!==!1,u=Math.round(i.GetPlaybackRate()*100)/100,r=f.extend([],l),r.length==0&&(r=[1]),e=n?1:-1,r.sort(function(n,t){return e*(n-t)}),t&&0>=e*(r[r.length-1]-u)?u=r[0]:f.each(r,function(n,t){if(0>=e*(t-u)&&0<e*(r[n+1]-u))return u=r[n+1],!1}),u}function positionUpdateTimerCallback(){var n=i.GetPosition();r.fire(u.PositionChanged,n),a=setTimeout(positionUpdateTimerCallback,it)}function startPositionUpdateTimer(){clearTimeout(a),a=setTimeout(positionUpdateTimerCallback,it)}function stopPositionUpdateTimer(){clearTimeout(a)}function reconnectOnLiveMediaOpenFailure(){t.controls.play()}function handleMediaError(){if(!y.HandleLiveMediaOpenFailure(reconnectOnLiveMediaOpenFailure)){var n;switch(t.currentMedia.error.errorCode){case-1072885294:case-1072885353:n=Mediasite.Player.Localization.MediaPlayer.FileNotFoundError;break;case-1072885352:n=Mediasite.Player.Localization.MediaPlayer.ServerConnectionError;break;case-1072885328:n=Mediasite.Player.Localization.MediaPlayer.ServerNotAvailable;break;default:n=t.currentMedia.error.errorDescription+" ("+t.currentMedia.error.errorCode+")"}r.fire(u.MediaError,n)}}function UseDefaultAudioLanguage(){t.controls.currentAudioLanguageIndex=t.controls.audioLanguageCount}function handleMediaEvent(f,o){var a,l,s;if(window.Mediasite)switch(f){case"OpenStateChange":o===12?(c.MediaLoadStart(),r.fire(u.MediaLoadStart)):o===13&&(h||i.Pause(),a=0,t.currentMedia.imageSourceHeight>0&&t.currentMedia.imageSourceWidth>0&&(a=t.currentMedia.imageSourceWidth/t.currentMedia.imageSourceHeight),l={AspectRatio:a,Duration:i.GetDuration(),AudioOnly:t.currentMedia.getItemInfo("MediaType")==="audio",CanChangeSpeed:!isLive(),CanFullScreen:!0,CurrentLanguageIndex:i.GetCurrentAudioLanguageIndex(),Languages:i.GetAudioLanguages(),StreamType:n.streamType,IsMainStream:n.isMainStream},c.UpdateMediaInfo(l),r.fire(u.MediaLoaded,l));break;case"PlayStateChange":switch(o){case Mediasite.Player.MediaState.Playing:i.SetPlaybackRate(rt),i.GetPosition()==0&&i.SetPosition(1),h&&t.controls.currentPosition<2&&(w=+new Date-h.getTime()-1e4),t.controls.audioLanguageCount>1&&UseDefaultAudioLanguage(),startPositionUpdateTimer();break;case Mediasite.Player.MediaState.MediaEnded:r.fire(u.PositionChanged,i.GetDuration());case Mediasite.Player.MediaState.Stopped:stopPositionUpdateTimer(),r.fire(u.PositionChanged,i.GetPosition()),e=0,tt=+new Date,r.fire(u.PositionChanged,0);break;case Mediasite.Player.MediaState.Paused:stopPositionUpdateTimer(),r.fire(u.PositionChanged,i.GetPosition());break;default:stopPositionUpdateTimer()}y.setMediaState(o),r.fire(u.StateChanged,o);break;case"PositionChange":k?k=!1:e=i.GetPosition();break;case"ScriptEvent":o.Type==="MS6"&&(s=parseInt(o.Command,10)-t.controls.currentPosition*1e3,isNaN(s)||(w=s)),r.fire(u.MediaEvent,o)}}function waitForPlayerInit(){if(!t.settings){setTimeout(waitForPlayerInit,200);return}t.settings.invokeURLs=!1,v===Mediasite.Player.MediaPlayerType.Port25?(OnDSPlayStateChangeEvt=function(n){handleMediaEvent("PlayStateChange",n)},OnDSPositionChangeEvt=function(n,t){handleMediaEvent("PositionChange",{newPosition:n,oldPosition:t})},OnDSOpenStateChangeEvt=function(n){handleMediaEvent("OpenStateChange",n)},OnDSScriptCommandEvt=function(n,t){handleMediaEvent("ScriptEvent",{Type:n,Command:t})},OnDSMediaErrorEvt=function(){handleMediaError()}):v===Mediasite.Player.MediaPlayerType.WindowsMedia&&t.attachWmpEvent&&(t.attachWmpEvent("OpenStateChange",function(n){handleMediaEvent("OpenStateChange",n)}),t.attachWmpEvent("PlayStateChange",function(n){handleMediaEvent("PlayStateChange",n)}),t.attachWmpEvent("PositionChange",function(n){handleMediaEvent("PositionChange",n)}),t.attachWmpEvent("ScriptCommand",function(n,t){handleMediaEvent("ScriptEvent",{Type:n,Command:t})}),t.attachWmpEvent("MediaError",function(){handleMediaError()})),t.URL=b,i.SetVolume(d),d===0&&(t.settings.mute=!0)}function isLive(){return!!h}var f=jQuery,i=this,g,t,b,ot=1,l=n.playbackRates,et=3e3,st=1e4,e=0,k=!1,ht=-2e3,ut=!1,d=100,h,w=0,y=new Mediasite.MediaPlayer.LiveMediaOpenReconnector,c,ft,rt=1,p=Mediasite.Logging.LoggerFactory("Media WindowsMedia:"+n.streamType,{separator:"\n"}),a=null,it=200,lt=null,ct=100,o=1,tt=0,at=300,vt={position:0,savedAt:0},yt={position:0,savedAt:0},r=new Mediasite.Player.EventBundle,u=Mediasite.MediaPlayer.ModelEvent,s=n.disableVolume==undefined?!1:n.disableVolume,v,nt;this.GetMediaWrapper=function(){return ft},this.SupportsPlayAsVideo=function(){return!1},this.AddEventHandler=function(n,t){r.addHandler(n,t)},v=n.mediaPlayerType,lt=setInterval(rateCheckTimer_tick,ct),this.SetupMediaElement=function(i){c=f.extend(new Mediasite.MediaPlayer.BaseView,new nt(n)),g=c.CreateMediaElement(),ft=c.Wrapper,t=g.get(0);for(var e=0;e<i.length;e++)if(i[e].MimeType===n.pluginMimeType){b=i[e].Location,p.Debug("Media element source added",i[e].MimeType,i[e].Location);break}if(typeof b=="undefined"){r.fire(u.MediaError,Mediasite.Player.Localization.MediaPlayer.NoCompatibleMediaError),p.Error("Media - no compatible media source");return}setTimeout(waitForPlayerInit,200),s&&this.Mute()},this.UpdateOptions=function(n){d=n.Volume},this.LiveStatusChange=function(n){y.setLiveStatus(n),n===Mediasite.Player.PresentationStatus.LiveEnded&&(i.Stop(),handleMediaEvent=function(){},handleMediaError=function(){})},this.InactivityExceeded=function(){ut=!0},this.SetPosition=function(n){n>=0&&n<i.GetDuration()&&(k=!0,e=n,t.controls.currentPosition=n/1e3,r.fire(u.PositionChanged,n))},this.PlayDefaultRate=function(){var n=ot;i.SetPlaybackRate(n)},this.PlayFaster=function(n){n=n===!0;var t=getNextPlaybackRate(!0,n);i.SetPlaybackRate(t)},this.PlaySlower=function(n){n=n===!0;var t=getNextPlaybackRate(!1,n);i.SetPlaybackRate(t)},this.SkipBack=function(){var n=i.GetPosition()-et;n<0&&(n=0),i.SetPosition(n)},this.SkipForward=function(){var n=i.GetPosition()+st;n<i.GetDuration()&&i.SetPosition(n)},this.FullScreen=function(){t.fullScreen=!0},this.Pause=function(){i.GetDuration()>0?t.controls.pause():i.Stop()},this.Play=function(){ut===!0?window.location.reload():(t.controls.play(),t.settings.rate!=o&&(t.settings.rate=o))},this.Stop=function(){t.controls.stop()},this.GetPosition=function(){var i=t.controls.currentPosition*1e3+w,n;return e>0&&(n=i-e,ht<n&&n<0)?e:i},this.GetDuration=function(){return t.currentMedia.duration*1e3},this.SetVolume=function(n){s?(t.settings.volume=0,t.settings.mute=n==0):(t.settings.volume=Math.round(n),t.settings.mute=n==0,r.fire(u.VolumeChanged,Math.round(i.GetVolume())))},this.GetVolume=function(){return t.settings.volume},this.StepVolumeUp=function(){s||(t.settings.volume<=80?this.SetVolume(this.GetVolume()+20):this.SetVolume(100))},this.StepVolumeDown=function(){s||(t.settings.volume>.2?this.SetVolume(this.GetVolume()-20):this.SetVolume(0))},this.ToggleMute=function(){s||(i.IsMuted()?i.UnMute():i.Mute())},this.Mute=function(){t.settings.mute=!0,i.IsMuted()&&r.fire(u.VolumeChanged,0)},this.UnMute=function(){s||(t.settings.mute=!1,i.GetVolume()===0?this.SetVolume(50):r.fire(u.VolumeChanged,Math.round(i.GetVolume())))},this.IsMuted=function(){return t.settings.mute},this.TogglePlayPause=function(){t.playState===Mediasite.Player.MediaState.Playing?i.Pause():i.Play()},this.SetPlaybackRate=function(n){rt=n,t&&(t.settings.rate=n)},this.GetPlaybackRate=function(){return t.settings.rate},this.GetCurrentAudioLanguageIndex=function(){try{return t.controls.currentAudioLanguageIndex}catch(n){return 0}},this.GetAudioLanguages=function(){var n,u=1,r,i;try{u=t.controls.audioLanguageCount}catch(f){}if(u>1){for(r=[],n=0;n<u;++n)i=t.controls.getAudioLanguageID(n+1),r[n]={Index:n+1,Locale:i,DisplayName:t.controls.getLanguageName(i)};return r}return{}},this.SetAudioLanguage=function(n){try{t.controls.currentAudioLanguageIndex=n.Index}catch(i){}},this.SetLiveStartTime=function(n){h=n},this.RetrieveBookmark=function(n){vt=n},nt=function(n){function makeParam(n,t){var i=document.createElement("param");return i.setAttribute("name",n),i.setAttribute("value",t),i}function makeWmpScripts(n){return""+makeWmpEventScript(n,"OpenStateChange")+makeWmpEventScript(n,"PlayStateChange")+makeWmpEventScript(n,"PositionChange")+makeWmpEventScript(n,"ScriptCommand")+makeWmpEventScript(n,"MediaError")}function makeWmpEventScript(n,t){return'<script for="'+n+'" event="'+t+'">if (typeof arguments !== "undefined") {document.getElementById("'+n+'").fireWmpEvent("'+t+'", arguments);}<\/script>'}var r="MediaElement",i,t;this.Wrapper=undefined,this.CreateMediaElement=function(){var e,u;return n.mediaContainer.find(".MediaWrapper").remove(),e=f('<div id="MediaWrapper" class="MediaWrapper"></div>').appendTo(n.mediaContainer),this.Wrapper=e,n.mediaPlayerType===Mediasite.Player.MediaPlayerType.Port25?f('<object id="MediaElement" type="application/x-ms-wmp"><param name="enableContextMenu" value="'+n.enableContextMenu+'"/><param name="stretchToFit" value="true"/><param name="windowlessVideo" value="false"/><param name="uiMode" value="none"/></object>').css("width",n.width).css("height",n.height).appendTo(e):(e.append(makeWmpScripts(r)),u=document.createElement("OBJECT"),u.appendChild(makeParam("windowlessVideo","true")),u.appendChild(makeParam("uiMode","none")),u.appendChild(makeParam("enableContextMenu",n.enableContextMenu)),u.appendChild(makeParam("stretchToFit","true")),n.height&&n.width&&(u.setAttribute("height",n.height),u.setAttribute("width",n.width)),u.setAttribute("id",r),u.setAttribute("classid","clsid:6BF52A52-394A-11d3-B153-00C04F79FAA6"),e.get(0).appendChild(u),t(u),i=f(u),f(u))},this.UpdateMediaInfo=function(n){n.AudioOnly&&i.css("height","0px")},t=function(n){var t={};n=f(n).get(0),n.attachWmpEvent=function(n,i){t[n]=t[n]||f.Callbacks(),t[n].add(i)},n.fireWmpEvent=function(n,i){t[n]&&t[n].fire&&t[n].fire.apply(window,i)}}}}
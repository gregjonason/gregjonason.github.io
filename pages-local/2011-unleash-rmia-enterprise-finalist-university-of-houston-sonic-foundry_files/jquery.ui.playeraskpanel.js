(function(n){n.widget("ui.playeraskpanel",{options:{onSendQuestion:null,dismissFunction:null,ids:{header:"ui-playeraskpanel-header",scroll:"ui-playeraskpanel-scroll",scrollWrapper:"ui-playeraskpanel-scroll-wrapper",nameField:"ui-playeraskpanel-name",emailField:"ui-playeraskpanel-email",subjectField:"ui-playeraskpanel-subject",messageField:"ui-playeraskpanel-message",timeCheckBox:"ui-playeraskpanel-time-checkbox",timeField:"ui-playeraskpanel-time",timeFormat:"ui-playeraskpanel-time-format",timeLabel:"ui-playeraskpanel-timeLabel",submitArea:"ui-playeraskpanel-submit",sendButton:"ui-playeraskpanel-sendBtn",modalMask:"ui-playeraskpanel-modalmask",msgDialog:"ui-playeraskpanel-message-dialog"},classes:{panel:"ui-playeraskpanel",form:"ui-playeraskpanel-form",inputStretch:"input-stretch",header:"panel-header",modalMask:"panel-modal-mask"},subject:{maxLength:512},message:{cols:20,rows:10},labelMargin:115,currentPosition:0,presentation:null,scrollbarColor:"rgba(255,255,255,0.5)",window:window,javascriptResize:!0,msgDialogWidth:undefined},_setOption:function(t,i){var u=this,r=u.options;r[t]=i,t==="presentation"&&r.presentation.PlayStatus!="OnDemand"&&u.hideTimeData(),t==="currentPosition"&&n("#"+r.ids.timeField,u.element).val(Mediasite.Player.TimeHelper.getDisplayFromDuration(r.currentPosition,!0))},_create:function(){var i=this,t=i.options,u,r;this._msgDialogInterval=0,i.element.addClass(t.classes.panel),u='<p id="'+t.ids.header+'" class="'+t.classes.header+'">'+Mediasite.Player.Localization.Buttons.Ask+'</p><div id="'+t.ids.scrollWrapper+'"><div id="'+t.ids.scroll+'"><form class="'+t.classes.form+'"><p><label for="'+t.ids.nameField+'">'+Mediasite.Player.Localization.AskQuestion.Name+'</label><input type="text" name="name" id="'+t.ids.nameField+'" class="'+t.classes.inputStretch+'" /></p><p><label for="'+t.ids.emailField+'">'+Mediasite.Player.Localization.AskQuestion.Email+'</label><input type="text" name="email" id="'+t.ids.emailField+'"  class="'+t.classes.inputStretch+'" /></p><p><label for="'+t.ids.subjectField+'">'+Mediasite.Player.Localization.AskQuestion.Subject+'</label><input type="text" name="subject" id="'+t.ids.subjectField+'" maxlength="'+t.subject.maxLength+'" class="'+t.classes.inputStretch+'" /></p><p><label for="'+t.ids.messageField+'">'+Mediasite.Player.Localization.Email.Message+'</label><textarea name="message" id="'+t.ids.messageField+'" rows="'+t.message.rows+'" cols="'+t.message.cols+'" class="'+t.classes.inputStretch+'"></textarea></p><p><label id="'+t.ids.timeLabel+'" for="'+t.ids.timeCheckBox+'">'+Mediasite.Player.Localization.AskQuestion.Time+'</label><input type="checkbox" name="timeCheckbox" id="'+t.ids.timeCheckBox+'"/><input type="text" name="time" id="'+t.ids.timeField+'" /><span id="'+t.ids.timeFormat+'">'+Mediasite.Player.Localization.AskQuestion.TimeFormat+'</span></p><p id="'+t.ids.submitArea+'"><input id="'+t.ids.sendButton+'" type="submit" value="'+Mediasite.Player.Localization.AskQuestion.AskButton+'" /></p></form></div></div><div id="'+t.ids.modalMask+'" class="'+t.classes.modalMask+'"></div>',i.divMarkup=n(u).appendTo(i.element),r=function(n){n.preventDefault(),i._sendQuestion()},n("form",i.element).bind("submit",r),n("#"+t.ids.sendButton,i.element).click(r),i._overlayState(!1),n("#"+t.ids.dismissDialog,i.element).click(function(){n("#"+t.ids.modalMask,i.element).hide()}),t.javascriptResize&&n(t.window).resize(function(){i.updateLayout()})},hideTimeData:function(){var t=this.options;n("#"+t.ids.timeCheckBox,self.element).hide(),n("#"+t.ids.timeField,self.element).hide(),n("#"+t.ids.timeFormat,self.element).hide(),n("#"+t.ids.timeLabel,self.element).hide()},updateLayout:function(){var i=this,r=i.options,u,t;n("."+r.classes.inputStretch,i.element).width(i.element.innerWidth()-r.labelMargin),n("#"+r.ids.messageField,i.element).width(i.element.innerWidth()-r.labelMargin-2),u=n("#"+r.ids.scrollWrapper,i.element),t=i.element.height(),t-=n("#"+r.ids.header,i.element).outerHeight(!0),t-=parseInt(u.css("margin-top"),10)||0,t-=parseInt(u.css("margin-bottom"),10)||0,t-=parseInt(u.css("padding-top"),10)||0,t-=parseInt(u.css("padding-bottom"),10)||0,t=t>0?t:20,u.height(t),n("#"+r.ids.scroll,i.element).iscroll({scrollbarColor:r.scrollbarColor})},destroy:function(){var n=this.options;this.element.removeClass(n.classes.panel),this.divMarkup.remove()},_init:function(){var i=this,t=i.options;n("#"+t.ids.timeField,i.element).val(Mediasite.Player.TimeHelper.getDisplayFromDuration(t.currentPosition,!0)),n("#"+t.ids.timeCheckBox,i.element).change(function(){n("#"+t.ids.timeCheckBox,i.element).is(":checked")?n("#"+t.ids.timeField,i.element).attr("disabled",!1):n("#"+t.ids.timeField,i.element).attr("disabled",!0)}).trigger("change"),t.presentation!=null&&t.presentation.PlayStatus!="OnDemand"&&i.hideTimeData(),t.javascriptResize&&this.updateLayout()},_sendQuestion:function(){function validateQuestion(){var r="",s=n("#"+t.ids.nameField,i.element).val(),e,o,f,u;return((!s||s.length<1)&&(r+="<br/> - "+Mediasite.Player.Localization.AskQuestion.NameRequired),e=n.trim(n("#"+t.ids.emailField,i.element).val()),e.length>0&&!validateEmailAddress(e)&&(r+="<br/> - "+Mediasite.Player.Localization.AskQuestion.EmailInvalid),o=n("#"+t.ids.subjectField,i.element).val(),(!o||o.length<1)&&(r+="<br/> - "+Mediasite.Player.Localization.AskQuestion.SubjectRequired),f=n("#"+t.ids.messageField,i.element).val(),(!f||f.length<1)&&(r+="<br/> - "+Mediasite.Player.Localization.AskQuestion.QuestionRequired),n("#"+t.ids.timeCheckBox,i.element).is(":checked")&&(u=n("#"+t.ids.timeField,i.element).val(),(!u||t.presentation&&Mediasite.Player.TimeHelper.getDurationFromDisplay(u)>t.presentation.Duration||Mediasite.Player.TimeHelper.getDurationFromDisplay(u)==-1)&&(r+="<br/> - "+Mediasite.Player.Localization.AskQuestion.QuestionTimeError)),r.length>0)?(i._displayMessage(Mediasite.Player.Localization.Buttons.Ask,"<strong>"+Mediasite.Player.Localization.AskQuestion.ValidationError+"</strong><br/>"+r),!1):!0}function validateEmailAddress(n){var t=/^[A-Z0-9.'_%+-]+@(?:[A-Z0-9-]+\.)+[A-Z]{2,4}$/i;return t.test(n)}var i=this,t=i.options,r,u;if(validateQuestion()&&(r=0,n("#"+t.ids.timeCheckBox,i.element).is(":checked")&&(r=Mediasite.Player.TimeHelper.getDurationFromDisplay(n("#"+t.ids.timeField,i.element).val())),u={Submitter:n("#"+t.ids.nameField,i.element).val(),SubmitterEmail:n("#"+t.ids.emailField,i.element).val(),Subject:n("#"+t.ids.subjectField,i.element).val(),QuestionText:n("#"+t.ids.messageField,i.element).val(),TimeInPresentation:r},jQuery.isFunction(t.onSendQuestion)))t.onSendQuestion(u)},sendQuestionComplete:function(t,i){var r=this,u=r.options,e=Mediasite.Player.Localization.AskQuestion.SendSuccessTitle,f;t?(i=Mediasite.Player.Localization.AskQuestion.SendSuccessDetail,n("#"+u.ids.subjectField,r.element).val(""),n("#"+u.ids.messageField,r.element).val(""),f=function(){n(r).unbind(),jQuery.isFunction(u.dismissFunction)&&u.dismissFunction()}):(e=Mediasite.Player.Localization.AskQuestion.SendFailureTitle,i.length==0&&(i=Mediasite.Player.Localization.AskQuestion.SendFailureDetail)),r._displayMessage(e,i,f)},_displayMessage:function(t,i,r){var u=this,e=u.options,f,o;u._overlayState(!0),u._killDisplayMessage(),f=n('<div id="'+e.ids.msgDialog+'"></div>'),f.appendTo(u.element),o={title:t,message:i,allowClose:!1,dialogClass:"panelMessage",width:e.msgDialogWidth?e.msgDialogWidth:u.element.innerWidth()-4,modal:!1,close:function(){u._overlayState(!1),n.isFunction(r)&&r()},position:{my:"center top",at:"center top+100",of:u.element},appendTo:u.element[0]},f.messagedisplay(o),u._msgDialogInterval=setInterval(function(){u.element.is(":visible")||(u._overlayState(!1),clearInterval(u._msgDialogInterval))},500)},_overlayState:function(t){var i=this,r=i.options;t?n("#"+r.ids.modalMask,i.element).show():n("#"+r.ids.modalMask,i.element).hide()},_killDisplayMessage:function(){var i=this,r=i.options,t=n("#"+r.ids.msgDialog,i.element);t.length>0&&(t.hasClass("messagedisplayinit")&&t.messagedisplay("destroy"),t.remove())}})})(jQuery)
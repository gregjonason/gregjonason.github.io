(function(n){n.widget("ui.playerinvitepanel",{options:{ids:{header:"ui-playerinvitepanel-header",scroll:"ui-playerinvitepanel-scroll",scrollWrapper:"ui-playerinvitepanel-scroll-wrapper",fromField:"ui-playerinvitepanel-from",toField:"ui-playerinvitepanel-to",toSeparator:"ui-playerinvitepanel-toSeparator",subjectField:"ui-playerinvitepanel-subject",messageField:"ui-playerinvitepanel-message",timeCheckBox:"ui-playerinvitepanel-time-checkbox",timeField:"ui-playerinvitepanel-time",timeFormat:"ui-playerinvitepanel-time-format",timeLabel:"ui-playerinvitepanel-timeLabel",submitArea:"ui-playerinvitepanel-submit",sendButton:"ui-playerinvitepanel-sendBtn",modalMask:"ui-playerinvitepanel-modalmask",msgDialog:"ui-playerinvitepanel-message-dialog",useClientLink:"ui-playerinvitepanel-useclient"},classes:{panel:"ui-playerinvitepanel",form:"ui-playerinvitepanel-form",header:"panel-header",inputStretch:"input-stretch",modalMask:"panel-modal-mask",toSeparator:"toseparator"},subject:{maxLength:512},message:{cols:20,rows:10},labelMargin:115,currentPosition:0,presentation:null,onSendEmail:null,dismissFunction:null,scrollbarColor:"rgba(255,255,255,0.5)",url:window.location.href,window:window,javascriptResize:!0,msgDialogWidth:undefined},_setOption:function(t,i){var u=this,r=u.options;r[t]=i,t==="presentation"&&r.presentation.PlayStatus!="OnDemand"&&u.hideTimeData(),t==="currentPosition"&&(n("#"+r.ids.timeField,u.element).val(Mediasite.Player.TimeHelper.getDisplayFromDuration(r.currentPosition,!0)),u._updateEmailText())},_create:function(){var i=this,t=i.options,u,r;i._msgDialogInterval=0,i.element.addClass(t.classes.panel),u='<p id="'+t.ids.header+'" class="'+t.classes.header+'">'+Mediasite.Player.Localization.Buttons.Email+'</p><div id="'+t.ids.scrollWrapper+'"><div id="'+t.ids.scroll+'"><form class="'+t.classes.form+'"><p><label for="'+t.ids.fromField+'">'+Mediasite.Player.Localization.Email.From+'</label><input type="text" name="from" id="'+t.ids.fromField+'" class="'+t.classes.inputStretch+'" /></p><p><label for="'+t.ids.toFiled+'">'+Mediasite.Player.Localization.Email.To+'</label><input type="text" name="to" id="'+t.ids.toField+'"  class="'+t.classes.inputStretch+'" /><br /><span id="'+t.ids.toSeparator+'" class="'+t.classes.toSeparator+'">'+Mediasite.Player.Localization.Email.ToSeparator+'</span></p><p><label for="'+t.ids.subjectField+'">'+Mediasite.Player.Localization.Email.Subject+'</label><input type="text" name="subject" id="'+t.ids.subjectField+'" maxlength="'+t.subject.maxLength+'" class="'+t.classes.inputStretch+'" /></p><p><label id="'+t.ids.timeLabel+'" for="'+t.ids.timeCheckBox+'">'+Mediasite.Player.Localization.Email.Time+'</label><input type="checkbox" name="timeCheckbox" id="'+t.ids.timeCheckBox+'"/><input type="text" name="time" id="'+t.ids.timeField+'" /><span id="'+t.ids.timeFormat+'">'+Mediasite.Player.Localization.Email.TimeFormat+'</span></p><p><label for="'+t.ids.messageField+'">'+Mediasite.Player.Localization.Email.Message+'</label><textarea name="message" id="'+t.ids.messageField+'" rows="'+t.message.rows+'" cols="'+t.message.cols+'" class="'+t.classes.inputStretch+'"></textarea></p><p id="'+t.ids.submitArea+'"><a id="'+t.ids.useClientLink+'" href="#">'+Mediasite.Player.Localization.Email.UseClient+'</a> <input id="'+t.ids.sendButton+'" type="submit" value="'+Mediasite.Player.Localization.Common.Send+'" /></p></form></div></div><div id="'+t.ids.modalMask+'" class="'+t.classes.modalMask+'"></div>',i.divMarkup=n(u).appendTo(i.element);n("#"+t.ids.useClientLink,i.element).on("mousedown",function(){i._updateEmailLink()});n("#"+t.ids.useClientLink,i.element).on("click",function(n){n.which!==1||n.metaKey||n.shiftKey||n.ctrlKey||n.shiftKey||(n.preventDefault(),i._useClientEmail())});r=function(n){n.preventDefault(),i._sendInvite()},n("form",i.element).bind("submit",r),n("#"+t.ids.sendButton,i.element).bind("click",r),i._overlayState(!1),n("#"+t.ids.timeCheckBox,i.element).change(function(){i._updateEmailText()}),n("#"+t.ids.timeField,i.element).attr("disabled",!0).change(function(){i._updateEmailText()}),t.javascriptResize&&n(t.window).resize(function(){i.updateLayout()})},hideTimeData:function(){var t=this.options;n("#"+t.ids.timeCheckBox,self.element).hide(),n("#"+t.ids.timeField,self.element).hide(),n("#"+t.ids.timeFormat,self.element).hide(),n("#"+t.ids.timeLabel,self.element).hide()},updateLayout:function(){var i=this,r=i.options,u,t;n(".input-stretch",i.element).width(i.element.innerWidth()-r.labelMargin),n("#"+r.ids.messageField,i.element).width(i.element.innerWidth()-r.labelMargin-2),u=n("#"+r.ids.scrollWrapper,i.element),t=i.element.height(),t-=n("#"+r.ids.header,i.element).outerHeight(!0),t-=parseInt(u.css("margin-top"),10)||0,t-=parseInt(u.css("margin-bottom"),10)||0,t-=parseInt(u.css("padding-top"),10)||0,t-=parseInt(u.css("padding-bottom"),10)||0,t=t>0?t:20,u.height(t),n("#"+r.ids.scroll,i.element).iscroll({scrollbarColor:r.scrollbarColor})},destroy:function(){var n=this.options;this.element.removeClass(n.classes.panel),this.divMarkup.remove()},_init:function(){var t=this,n=t.options;n.presentation!=null&&n.presentation.PlayStatus!="OnDemand"&&t.hideTimeData(),n.javascriptResize&&this.updateLayout()},updateEmailInvite:function(t){var i=this,r=i.options;if(n("#"+r.ids.subjectField,i.element).val(t.Subject),n("#"+r.ids.messageField,i.element).val(t.Message),n("#"+r.ids.toField,i.element).val(""),n("#"+r.ids.useClientLink,i.element).attr("href",this._getShareLink()),t.UseServerForSMTP)return n("#"+r.ids.timeField,i.element).val(Mediasite.Player.TimeHelper.getDisplayFromDuration(r.currentPosition,!0)),i._updateEmailText(),!1;i._useClientEmail()},_updateEmailLink:function(){var t=this,i=t.options;n("#"+i.ids.useClientLink,t.element).attr("href",this._getShareLink())},_updateEmailText:function(){var t=this,i=t.options,o=/\bhttps?:\/\/[-A-Z0-9+&@\/%=~_|!:,.;]+\/Play\/[-A-Z0-9+&@#\/%?=~_|!:,.;]+[-A-Z0-9+&@#\/%=~_|]/ig,f=0,e,u,r;(n("#"+i.ids.timeCheckBox,t.element).is(":checked")?(f=Mediasite.Player.TimeHelper.getDurationFromDisplay(n("#"+i.ids.timeField,t.element).val()),n("#"+i.ids.timeField,t.element).removeAttr("disabled")):n("#"+i.ids.timeField,t.element).attr("disabled",!0),e=n("#"+i.ids.messageField,t.element).val(),u=o.exec(e),u!=null)&&(r=u[0].replace(/([\?&])?playFrom=\d+&?/ig,"$1").replace(/[\?&]$/,""),f>0&&(r+=(r.indexOf("?")>0?"&":"?")+"playFrom="+f),n("#"+i.ids.messageField,t.element).val(e.replace(o,r)))},sendInviteComplete:function(t,i){var r=this,e=r.options,f=Mediasite.Player.Localization.Email.SendSuccessTitle,u;t?u=function(){n(r).unbind(),jQuery.isFunction(e.dismissFunction)&&e.dismissFunction()}:f=Mediasite.Player.Localization.Email.SendErrorTitle,r._displayMessage(f,i,u)},_getShareLink:function(){var r=this,i=r.options,t=Mediasite.Urls.EscapeForMailto,u="mailto:"+t(n("#"+i.ids.toField,r.element).val())+"?subject="+t(n("#"+i.ids.subjectField,r.element).val())+"&body="+t(n("#"+i.ids.messageField,r.element).val());return u.length>1e3&&(u="mailto:"+t(n("#"+i.ids.toField,r.element).val())+"?subject="+t(n("#"+i.ids.subjectField,r.element).val())+"&body="+t(i.url)),u},_useClientEmail:function(){var u=this,r=u.options,t,i;jQuery.isFunction(r.dismissFunction)&&r.dismissFunction(),t=u._getShareLink(),Mediasite.BrowserDetect.Chrome()&&!Mediasite.BrowserDetect.ChromeAndroid()?(i=window.open(t),setTimeout(function(){i&&i.close()},1)):window.location=t},_sendInvite:function(){function validateEmailAddress(n){var t=/^[A-Z0-9.'_%+-]+@(?:[A-Z0-9-]+\.)+[A-Z]{2,4}$/i;return t.test(n)}function validateEmailMessage(r,u){var s=0,f="",h,e,o;return(validateEmailAddress(r)||s++,h=0,n.each(u,function(n){validateEmailAddress(u[n])?h++:s++}),(n("#"+t.ids.subjectField,i.element).val()==""||n.trim(n("#"+t.ids.subjectField,i.element).val())=="")&&(f+="<br/> - "+Mediasite.Player.Localization.Email.SubjectRequired),(n("#"+t.ids.messageField,i.element).val()==""||n.trim(n("#"+t.ids.messageField,i.element).val())=="")&&(f+="<br/> - "+Mediasite.Player.Localization.Email.MessageRequired),e=!0,t.presentation!=null&&t.presentation.PlayStatus=="OnDemand"&&(o=n("#"+t.ids.timeCheckBox,i.element),o.length>0&&o[0].checked&&((n("#"+t.ids.timeField,i.element).val().length<1||Mediasite.Player.TimeHelper.getDurationFromDisplay(n("#"+t.ids.timeField,i.element).val())>t.presentation.Duration)&&(e=!1,f+="<br/> - "+Mediasite.Player.Localization.Email.TimeInvalid),Mediasite.Player.TimeHelper.getDurationFromDisplay(n("#"+t.ids.timeField,i.element).val())==-1&&(e=!1,f+="<br/> - "+Mediasite.Player.Localization.Email.TimeFormatError))),(s>0||h<1)&&(f+="<br/> - "+Mediasite.Player.Localization.Email.InviteInvalid),f!="")?(i._displayMessage(Mediasite.Player.Localization.Buttons.Email,"<strong>"+Mediasite.Player.Localization.Email.ValidationError+"</strong><br/>"+f+"<br/>"),!1):!0}var i=this,t=i.options,u=[],r,f;if(n.each(n("#"+t.ids.toField,i.element).val().split(";"),function(t,i){n.trim(i).length>0&&u.push(n.trim(i))}),r=n.trim(n("#"+t.ids.fromField,i.element).val()),validateEmailMessage(r,u)&&(f={ToAddresses:u,FromAddress:r,Subject:n("#"+t.ids.subjectField,i.element).val(),MessageBody:n("#"+t.ids.messageField,i.element).val(),Time:Mediasite.Player.TimeHelper.getDurationFromDisplay(n("#"+t.ids.timeField,i.element).val())},jQuery.isFunction(t.onSendEmail)))t.onSendEmail(f)},_displayMessage:function(t,i,r){var u=this,e=u.options,f,o;u._overlayState(!0),u._killDisplayMessage(),f=n('<div id="'+e.ids.msgDialog+'"></div>'),f.appendTo(u.element),o={title:t,message:i,allowClose:!1,dialogClass:"panelMessage",width:e.msgDialogWidth?e.msgDialogWidth:u.element.innerWidth()-4,modal:!1,close:function(){u._overlayState(!1),n.isFunction(r)&&r()},position:{my:"center top",at:"center top+100",of:u.element},appendTo:u.element},f.messagedisplay(o),u._msgDialogInterval=setInterval(function(){u.element.is(":visible")||(u._overlayState(!1),clearInterval(u._msgDialogInterval))},500)},_overlayState:function(t){var i=this,r=i.options;t?n("#"+r.ids.modalMask,i.element).show():n("#"+r.ids.modalMask,i.element).hide()},_killDisplayMessage:function(){var i=this,r=i.options,t=n("#"+r.ids.msgDialog,i.element);t.length>0&&(t.hasClass("messagedisplayinit")&&t.messagedisplay("destroy"),t.remove())}})})(jQuery)
define(["jquery","version!fly/managers/debug","utils/cookie","version!fly/managers/gpt","managers/tealium","managers/page-vars","version!fly/utils/url-helper","managers/video","managers/device","managers/client-storage","version!fly/components/base","version!libs/jquery/lazyload","version!libs/jquery/ui/jquery.ui.draggable","version!libs/waypoints/jquery.waypoints"],function(e,t,i,a,n,o,s,r,l,d){t=t.init("cnetVideo"),window.mpulseUserTiming={adend:0,showplayoverlay:0,cnetvideocreate:0,playerloaded:0,contentstart:0,releaselected:0,adstart:0,initpdk:0},r.init(),e.widget("cnet.cnetVideo",e.fly.base,{options:{video:null,config:null,runtime:null,policy:null,videoType:"03",baseUrl:"/",timelineContainer:null,layoutUrl:null,skinUrl:null,relatedItems:null,autoplay:!1,timeRange:"",popOnScroll:!1,popOutOffset:-160,refreshAds:null,noFlashTitle:"Flash Player upgrade required",noFlashMessage:'Please <a href="http://get.adobe.com/flashplayer/" target="_new">download and install</a>  the latest version of the Adobe Flash Player to watch this video.',vidInfoContainer:""},chapterData:[],playNewRelease:!1,autoPlayNext:!1,feedId:"",protocol:document.location.protocol,type:"default",videoType:null,video:null,config:null,policy:null,instance:null,runtime:null,plugins:null,lastPercentComplete:0,currentSegment:null,segmentTimePlayed:0,omnitureParams:null,omnitureAdParams:null,dwParams:null,dwAdParams:null,isAd:!1,adPos:"PRE",player:null,partnerId:null,readyToPlay:!1,poppedOut:!1,isPlaying:!1,playbackNotStarted:!0,autoplayControlEnabled:!1,popOutWaypoint:null,trackPlayButtonClick:!0,sharingSites:{sharingSiteFacebook:{id:"facebook",title:"Facebook",icon:"images/icons/facebook.png",postUrl:"http://www.facebook.com/sharer.php?u={playerURL}&t={title}"},sharingSiteTwitter:{id:"twitter",title:"Twitter",icon:"images/icons/twitter.png",postUrl:"http://twitter.com/intent/tweet?text=Watching%20{title}&url={playerURL}"},sharingSiteTumblr:{id:"tumblr",title:"Tumblr",icon:"images/icons/tumblr.png",postUrl:"Flash"==this.runtime?"http://www.tumblr.com/share/video?caption={title}&embed={embeddedPlayerHTML}":"http://www.tumblr.com/share/link?url={playerURL}&name=Watching%20{title}"},sharingSiteGoogleplus:{id:"googleplus",title:"Google+",icon:"images/icons/googlePlus.png",postUrl:"https://plus.google.com/share?url={playerURL}"},sharingSiteReddit:{id:"reddit",title:"Reddit",icon:"images/icons/reddit.png",postUrl:"http://reddit.com/submit?url={playerURL}&title={title}"},sharingSiteDigg:{id:"digg",title:"Digg",icon:"images/icons/digg.png",postUrl:"http://digg.com/submit?phase=2&url={playerURL}&title={title}&bodytext={description}&media=video"}},_create:function(){var i=this;if(t.log("_create(): start"),this._setFeedFilter(),t.log("_create() - this.options.videos before if",this.options.videos),t.log("_create() - relatedItems before if",this.options.relatedItems),this.options.videos){var a;e.isArray(this.options.videos)?(a=this.options.videos.shift(),this.options.videos.push(a)):a=this.options.videos,t.log("_create() - inside creating this.options.videos",this.options.videos),this.options.video=a}if(this.trackPerformanceEvent("cnetvideocreate"),(""===this.options.relatedItems||null==this.options.relatedItems)&&this.options.videos){this.options.relatedItems="",t.log("_create() - this.options.videos",this.options.videos);for(var n=0;n<this.options.videos.length;n++)this.options.relatedItems+=this.options.videos[n].mpxId+"|"}t.log("_create() - video",this.options.video),t.log("_create() - videos",this.options.videos),t.log("_create() - relatedItems",this.options.relatedItems),this.options.video.primaryTopic||(this.options.video.primaryTopic={id:null}),this._setFeedFilter();var o=this.options,s=Math.floor(1e6*Math.random()+1);this._setup(),this.instance="player"+s,this.$element.attr("id",this.instance),this.video=o.video,this.videoType=o.videoType,null!=o.runtime&&(this.runtime=o.runtime),this.config=[];for(var l in o.config)"function"==typeof o.config[l]?this[l]=o.config[l]:this.config[l]=o.config[l];this.config.autoload=void 0!==this.config.autoload?this.config.autoload:!1,this.plugins=e.map(this.config.players[this.type].plugins,function(e,t){return e}),null!=o.policy?this.policy=o.policy:null!=this.config.policies[this.type]&&(this.policy=this.config.policies[this.type]),null!=this.options.partnerId?this.partnerId=this.options.partnerId:this.partnerId=this.config.tracking.can_partner_id,e.inArray("omniture",this.plugins)>-1&&(this.omnitureParams={channel:"video",videoContentType:"video",videoTitle:this.video.title||this.video.headline,videoId:this.video.mpxRefId,videoPartnerId:this.partnerId,collectionId:[null!=this.video.primaryCollection?this.video.primaryCollection.id:null]}),e.inArray("dw",this.plugins)>-1&&(this.dwParams={medastid:595,mapp:"MPX_PLAYER",medtitle:this.video.title||this.video.headline,medid:this.video.id,pageurl:document.location.href,v17:this.video.primaryTopic.id,V19:"video",v22:this.video.mpxRefId}),r.mpxIsLoaded()?this._initPDK():e(window).on("mpxLoaded",function(){i._initPDK()}),this.options.popOnScroll&&this._setupPopOnScroll()},_initPDK:function(){if(t.log("_initPDK() - "+(new Date).getTime()+": cnetVideo initPDK: "+this.instance),t.log("_initPDK() - cnetVideo video ---------------"),t.log("_initPDK() - ",this.video),t.log("_initPDK() - --------------- cnetVideo video"),t.log("_initPDK() - --------------- pageVars",o),e('script[data-item="abCheck"]',this.$element).length>0&&!o.noAdBlock)return this.displayAlert(this.options.adBlockTitle,this.options.adBlockMessage),void this.trackPerformanceEvent("adblock");if("Flash"==this.runtime&&!this.hasFlash())return this.displayAlert(this.options.noFlashTitle,this.options.noFlashMessage),void this.trackPerformanceEvent("noflashdetected");this.$element.attr("id","cnetVideoPlayer"),this.$element.append('<div class="tpPlayer '+this.runtime.toLowerCase()+'" id="'+this.instance+'"></div>');var i=new Player(this.instance);i.scopes=this.instance+"_scope",this.trackPerformanceEvent("initpdk"),this.player=i,i.layoutUrl=this.options.layoutUrl,i.skinUrl=this.options.skinUrl,i.playerUrl=this.options.baseUrl+"videos/link/{guid}/";var a=this.options.baseUrl+"videos/share/id/{guid}/";i.embeddedPlayerHTML='<iframe src="'+a+'" width="480" height="270" frameBorder="0" seamless="seamless" allowFullScreen></iframe>';for(var n in this.config.players[this.type].colors)this.config.players[this.type].colors.hasOwnProperty(n)&&(i[n]=this.config.players[this.type].colors[n]);null!=this.runtime&&(i.runtime=this.runtime),t.log("_initPDK() - cnetVideo player.runtime: "+i.runtime),i.showNav=!0,i.allowLink=!0,i.expandVideo=!0,i.videoScalingMethod="resize",i.allowBandwidth=!0,i.useRelativeTimeline=!1,document.location.search.indexOf("cnetVideo")>=0&&(i.logLevel=window.tpLogLevel="debug"),i.releaseUrl=this.getReleaseUrl(this.findPid()),i.autoPlay=i.autoplay="https:"==this.protocol||"HTML5"==this.runtime?!1:this.options.autoplay,t.log("_initPDK() - player.autoPlay: "+i.autoPlay),o.tracking.data.pageType,o.guid,i.pluginDoubleclick="type=adComponent|url="+o.video.tpBaseUrl+"/swf/doubleclick.swf|priority=1|host=pubads.g.doubleclick.net,ad.doubleclick.net",i.pluginDoubleclickJS="type=adComponent|url="+o.video.tpBaseUrl+"/js/plugins/doubleclick.js|priority=2|hosts=pubads.g.doubleclick.net%2Cad.doubleclick.net",t.log("_initPDK() - player.pluginDoubleclick: "+i.pluginDoubleclick),t.log("_initPDK() - player.pluginDoubleclickJS: "+i.pluginDoubleclickJS),i.pluginAkamaiMediaAnalyticsSwf="type=tracking|URL=http://79423.analytics.edgesuite.net/csma/pdk/PDKCSMALoader.swf|configPath=http://ma61-r.analytics.edgesuite.net/config/beacon-1916.xml",i.pluginAkamaiMediaAnalyticsJs="type=tracking|URL=http://79423.analytics.edgekey.net/js/loader/pdk/akamaiAnalyticsPDKLoader.js|configPath=http://ma61-r.analytics.edgesuite.net/config/beacon-1916.xml",i.pluginAkamaiSwf="type=player|URL="+o.video.tpBaseUrl+"/swf/akamaiHD.swf|priority=1|hosts=.akamaihd.net,hdnetwork.akamai",i.pluginAkamaiJs="type=player|URL="+o.video.tpBaseUrl+"/js/plugins/akamaiHD.js|priority=1|hosts=.akamaihd.net,hdnetwork.akamai";var s=this;e.each(this.getSharingSiteKeys(),function(e,a){i[a]=s.getSharingSiteOptions(a),t.log("player["+a+"] = "+s.getSharingSiteOptions(a))}),t.log("_initPDK() - this.options.relatedItems: "+this.options.relatedItems),""!==this.options.relatedItems&&"HTML5"!=this.runtime&&(i.relatedItemsURL=this.getFeedUrl(this.options.relatedItems),t.log("_initPDK() - player.relatedItemsURL: ",i.relatedItemsURL)),"HTML5"==this.runtime&&(i.endCard="none"),i.bind();var r=this;window.setTimeout(function(){r._registerListeners(),$pdk.initialize()},100)},_setFeedFilter:function(){this.options.runtime=l.isDesktopUserAgent()?"Flash":"HTML5";var e;e=l.isMobileUserAgent()?"3g":l.isIPhone()?"hls_phone":l.isIPad()?"hls_tablet":"rtmp",t.log("_setFeedFilter() - Filtering on "+e),this.feedId=e},getFeedUrl:function(e){t.log("getFeedUrl: "+e);var i=this.protocol+"//feed.theplatform.com/f/kYEXFC/"+this.feedId;return void 0!==e&&(i+="/?byId="+e),t.log("feedUrl: "+i+" / "+e),i},getAdPolicyParams:function(){var i=this.policy,a=o.ads.data.gpt.targeting.microsite;a="string"==typeof a?a:"";var n=l.isDesktopUserAgent()?"xml_vmap1":"xml_vast2",r=this.cleanVar(o.ads.data.gpt.targeting.test),d="&policy="+i;return d+="&partner="+this.getAdParter(),d+="&referrer_url="+location.href.split("#")[0],d+="&timestamp="+(new Date).getTime(),d+="&ptype="+o.tracking.data.pageType,d+="&vguid="+o.guid,d+="&session="+o.ads.data.gpt.targeting.session,d+="&sub_session="+o.ads.data.gpt.targeting.subses,d+="&cid="+o.ads.data.gpt.targeting.cid,d+="&microsite="+a,d+="&collection="+o.ads.data.gpt.targeting.collection,d+="&output="+n,d+="&mfr="+this.cleanVar(o.ads.data.gpt.targeting.mfr),d+="&carrier="+this.cleanVar(o.ads.data.gpt.targeting.carrier),d+="&section="+this.cleanVar(o.ads.data.gpt.targeting.section),d+="&userGroup="+this.cleanVar(o.ads.data.gpt.targeting.userGroup),d+="&tag="+this.cleanVar(o.ads.data.gpt.targeting.tag),d+="&edition="+this.cleanVar(o.ads.data.gpt.targeting.edition),d+="&test="+r,"video_preroll|1|no_ad"===r&&0===o.video.playCount&&(d+="&disablePreroll=true"),e.each(s.getAllParams(),function(e,t){var i=e.match(/adTargeting_(.+)/);i&&i[1]?d+="&"+i[1]+"="+t:"adNetwork"===e&&(d+="&network="+t)}),t.log("getAdPolicyParams: "+d),d},cleanVar:function(e){return void 0===e||"||"==e?"":e},getAdParter:function(){var e;switch(o.tracking.data.siteSection){case"home":e="portal";break;case"news":e="news";break;case"reviews":e="reviews";break;case"videos":e="cnettv";break;case"how-to":e="howto";break;case"about":e="about";break;default:e="misc"}return"HTML5"==this.runtime&&(e+="_m"),"es"===o.tracking.data.siteEdition&&(e="HTML5"==this.runtime?"es-cnet_mobile/"+e:"es-cnet/"+e),t.log("Ad parnter: "+e),e},initTrackingData:function(){t.log("initTrackingData",this.video),this.omnitureParams={channel:"video",videoContentType:"video",videoTitle:this.video.title||this.video.headline,videoId:this.video.mpxRefId,videoPartnerId:this.partnerId,articleAuthorId:[null!=this.video.author?this.video.author.id:null],articleAuthorName:[null!=this.video.author?this.video.author.firstName+" "+this.video.author.lastName:null],collectionId:[null!=this.video.primaryCollection?this.video.primaryCollection.id:null]},t.log("this.omnitureParams",this.omnitureParams),this.dwParams={medastid:595,mapp:"MPX_PLAYER",medtitle:this.video.title||this.video.headline,medid:this.video.id,pageurl:document.location.href,v17:this.video.primaryTopic.id,V19:"video",v22:this.video.mpxRefId},t.log("this.dwParams",this.dwParams)},initChapterStarts:function(){if(!$pdk.controller)return void window.setTimeout(this.initChapterStarts,50);if(t.log("initChapterStarts"),this.chapterData=[],$pdk.controller.clearAnnotations([this.instance]),this.video.chapters&&this.video.chapters.data&&this.video.chapters.data.length>0){for(var i=0;i<this.video.chapters.data.length;i++){var a=1e3*this.video.chapters.data[i].time,n="time"+a.toString();this.chapterData[n]=this.video.chapters.data[i],this.chapterData[n].hasSeen=!1,this.chapterData[n].ms=a}t.log("this.chapterData: "+this.chapterData),t.log(this.chapterData);for(var o in this.chapterData)if(this.chapterData.hasOwnProperty(o)&&(t.log(o+" = "+this.chapterData[o]),$pdk.controller.addAnnotation({time:this.chapterData[o].ms,type:1},[this.instance]),e(".tpScrubber"))){var s=100*this.chapterData[o].time/this.video.duration,r=s*e(".tpScrubber").width()/100;e(".tpScrubber").prepend('<div class="chapterDot" style="left:'+r+'px" id="'+this.chapterData[o].ms+'"></div>')}}},getReleaseUrl:function(e){if($pdk.controller){var i=this.protocol+"//link.theplatform.com/s/"+this.config.players[this.type].mpx_account+"/"+e+"?format=SMIL&mbr=true";return i+=this.getAdPolicyParams()+this.options.timeRange,this.options.timeRange="",this.useHdsMedia()&&(i+="&manifest=f4m"),t.log("getReleaseUrl() - releaseUrl: "+i),i}return null},pause:function(){this.isPlaying=!1,$pdk.controller&&$pdk.controller.pause(!0,[this.player._markupId])},unpause:function(){$pdk.controller&&$pdk.controller.pause(!1,[this.player._markupId])},playVideo:function(i){if(i.id===this.video.id)return void t.log("Video is already playing; ignore this request.");if(o.video.playCount++,this.video=e.isArray(i)?i[0]:i,t.log("playVideo: ",this.video),t.log(this.video),$pdk.controller){this.playNewRelease=!0,$pdk.controller.clearCurrentRelease([this.instance]),$pdk.controller.resetPlayer([this.instance]),$pdk.controller.hidePlayerRegions(!0,[],[this.instance]),$pdk.controller.hidePlayerCard("forms");var a=this.getReleaseUrl(this.findPid());t.log("releaseUrl: "+a),$pdk.controller.setReleaseURL(a,!0,[this.instance]),$pdk.controller.hidePlayerRegions(!1,[],[this.instance]);var n=this.positionInPlaylist(this.video.mpxId);if(n>-1){var s=this.options.videos.splice(0,n+1);this.options.videos=this.options.videos.concat(s)}}},positionInPlaylist:function(e){for(var t=0;t<this.options.videos.length;t++)if(this.options.videos[t].mpxId==e)return t;return-1},_registerListeners:function(t){return $pdk.controller?($pdk.controller.addEventListener("OnPlayerLoaded",e.proxy(this._onPlayerLoaded,this)),$pdk.controller.addEventListener("OnReleaseStart",e.proxy(this._onReleaseStart,this),[this.instance]),$pdk.controller.addEventListener("OnReleaseEnd",e.proxy(this._onReleaseEnd,this),[this.instance]),$pdk.controller.addEventListener("OnReleaseSelected",e.proxy(this._onReleaseSelected,this),[this.instance]),$pdk.controller.addEventListener("OnReleaseError",e.proxy(this._onReleaseError,this),[this.instance]),$pdk.controller.addEventListener("OnMediaStart",e.proxy(this._onMediaStart,this),[this.instance]),$pdk.controller.addEventListener("OnMediaPlaying",e.proxy(this._onMediaPlaying,this),[this.instance]),$pdk.controller.addEventListener("OnMediaComplete",e.proxy(this._onMediaComplete,this),[this.instance]),$pdk.controller.addEventListener("OnMediaPause",e.proxy(this._onMediaPause,this),[this.instance]),$pdk.controller.addEventListener("OnMediaError",e.proxy(this._onMediaError,this),[this.instance]),$pdk.controller.addEventListener("OnShowControls",e.proxy(this._onShowControls,this),[this.instance]),$pdk.controller.addEventListener("OnAnnotationPlayed",e.proxy(this._onAnnotationPlayed,this),[this.instance]),$pdk.controller.addEventListener("OnAnnotationSeeked",e.proxy(this._onAnnotationSeeked,this),[this.instance]),$pdk.controller.addEventListener("OnRefreshReleaseModel",e.proxy(this._onRefreshReleaseModel,this),[this.instance]),$pdk.controller.addEventListener("OnShowPlayOverlay",e.proxy(this._onShowPlayOverlay,this),[this.instance]),$pdk.controller.addEventListener("OnPlayButtonClicked",e.proxy(this._onPlayButtonClicked,this),[this.instance]),$pdk.controller.addEventListener("OnPdkTrace",e.proxy(this._onPdkTrace,this),[this.instance]),void $pdk.controller.addEventListener("OnStreamSwitched",e.proxy(this._onStreamSwitched,this),[this.instance])):void window.setTimeout(this._registerListeners,50)},_onAnnotationPlayed:function(e){this._onAnnotationEvent(e)},_onAnnotationSeeked:function(e){this._onAnnotationEvent(e)},_onAnnotationEvent:function(e){t.log("_onAnnotation: "),t.log(e);var i=e.data&&e.data.time?e.data&&e.data.time:null;if(i){var a="time"+i.toString();this.chapterData[a]&&this.chapterData[a].hasSeen===!1&&(this.chapterData[a].hasSeen=!0,this._relayEvent("timelineEvent",this.chapterData[a]))}},_onStreamSwitched:function(e){},_onMediaStart:function(i){t.log("_onMediaStart() - ",i),this.playbackNotStarted=!1,this.options.popOnScroll&&this.initPopOut();var s=o.tracking.data.siteSection?o.tracking.data.siteSection:"home";if(this.config.tracking.comscore_sect_id=this.config.tracking["comscore_"+s],i.data.baseClip.isAd)this.videoType=i.data.baseClip.isMid?"11":"09";else{var r=6e4;this.videoType=i.data.mediaTime/r>25?"03":"02"}if(t.log("_onMediaStart() - ComScore values: c2 = "+this.config.tracking.comscore_id+", c4 = "+this.config.tracking.comscore_sect_id+", c5 = "+this.videoType),this.config.tracking.nielsen_vcid=this.config.tracking["nielsen_vcid_"+s],t.log("_onMediaStart() - Nielsen values: cid: "+this.config.tracking.nielsen_cid+", vcid: "+this.config.tracking.nielsen_vcid),this._isAd(i)){if($pdk.controller.clearAnnotations([this.instance]),this.trackPerformanceEvent("adstart"),null!=this.options.refreshAds)try{t.log("_onMediaStart() - refresh ads: ",this.options.refreshAds),a.refresh(o.guid,this.options.refreshAds)}catch(l){t.log("_onMediaStart() - could not refresh ads")}}else this.initChapterStarts(),$pdk.controller.disablePlayerControls(!1,[],[this.instance]),this.trackPerformanceEvent("contentstart");if(this._lazyLoadImages(),this.isAd=this._isAd(i),this.lastPercentComplete=0,this.isAd){var d=i.data.baseClip.banners;"object"==typeof d&&d.length>0&&e("#marquee_top").html('<a href="'+d[0].href+'" target="_blank"><img src="'+d[0].src+'" /></a>')}void 0!==this.onMediaStart&&this.onMediaStart(i),e.inArray("omniture",this.plugins)>-1&&(this.segmentTimePlayed=0,this.isAd?(this.currentSegment="0:A:"+this.adPos+":0:1",this.omnitureAdParams=e.extend({videoAdIds:i.data.baseClip.id,videoAdTitle:i.data.baseClip.title},this.omnitureParams),params=e.extend({videoSegments:this.currentSegment},this.omnitureAdParams),n.trackVideo("ad",0,params)):(this.currentSegment="0:M:0",params=e.extend({videoSegments:this.currentSegment},this.omnitureParams),e.inArray("dw",this.plugins)>-1&&(params=e.extend(params,this.dwParams)),n.trackVideo("play",0,params),this.adPos="MID")),e.inArray("comscore",this.plugins)>-1&&this._comscoreTracking(),e.inArray("nielsen",this.plugins)>-1&&(this.isAd||this._nielsenTracking()),this._relayEvent("onMediaStart",i)},_onMediaPlaying:function(t){this.isPlaying=!0;var i=[75,50,25],a=!1;for(var o in i)if(t.data.percentComplete>=i[o]&&this.lastPercentComplete<i[o]){a=i[o];break}if(void 0!==this.onMediaPlaying&&this.onMediaPlaying(t),a&&e.inArray("omniture",this.plugins)>-1&&(this.isAd?(this.currentSegment=(75==a?"3":50==a?"2":"1")+":A:"+this.adPos+":0:1",params=e.extend({videoSegments:this.currentSegment,videoTime:String(Math.ceil(t.data.duration/1e3/4))-this.segmentTimePlayed},this.omnitureAdParams),n.trackVideo("ad",a,params)):(this.currentSegment=75==a?"3:M:50-75":50==a?"2:M:25-50":"1:M:0-25",params=e.extend({videoSegments:this.currentSegment,videoTime:String(Math.ceil(t.data.duration/1e3/4))-this.segmentTimePlayed},this.omnitureParams),e.inArray("dw",this.plugins)>-1&&e.extend(params,{gestval:"pct:"+a},this.dwParams),n.trackVideo("play",a,params)),this.segmentTimePlayed=0),this.lastPercentComplete=t.data.percentComplete,this.video.chapters&&this.video.chapters.data&&this.video.chapters.data.length>0){var s=1e3*Math.round(t.data.currentTime/1e3),r="time"+s;if(this.chapterData.hasOwnProperty(r)){var l={data:{time:s}};this._onAnnotationEvent(l)}}},_onMediaComplete:function(i){t.log("_onMediaComplete",i),i.data.baseClip.isAd?(t.log("_onMediaComplete","ad ended"),this.trackPerformanceEvent("adend")):(t.log("_onMediaComplete","content ended"),this.trackPerformanceEvent("contentend"),this.autoPlayNext=!0,this.playNextVideo()),void 0!==this.onMediaComplete&&this.onMediaComplete(i),this._relayEvent("onMediaComplete",i),e.inArray("omniture",this.plugins)>-1&&(this.isAd?(this.currentSegment="4:A:"+this.adPos+":0:1",params=e.extend({videoSegments:this.currentSegment,videoTime:String(Math.ceil(i.data.length/1e3/4))-this.segmentTimePlayed},this.omnitureAdParams),n.trackVideo("ad",100,params)):(this.currentSegment="4:M:75-100",params=e.extend({videoSegments:this.currentSegment,videoTime:String(Math.ceil(i.data.length/1e3/4))-this.segmentTimePlayed},this.omnitureParams),e.inArray("dw",this.plugins)>-1&&e.extend(params,this.dwParams),n.trackVideo("play",100,params),this.adPos="POST"))},_onMediaPause:function(i){t.log("_onMediaPause",i),this.isPlaying=!1;try{var a=Math.ceil(i.data.clip.mediaLength/1e3/4),o=Math.ceil(i.data.clip.mediaTime/1e3);this.segmentTimePlayed=o-Math.floor(o/a)*a,this.isAd||n.trackVideo("pause",this.segmentTimePlayed,e.extend({levtEventType:"videoTime",videoSegments:this.currentSegment,videoTime:this.segmentTimePlayed},this.omnitureParams))}catch(s){}},_onMediaError:function(e){t.log("onMediaError",e),this._super(e)},_onShowControls:function(){t.log("OnShowControls"),e('[data-item="loadingCircle"]',this.$element).remove()},_onReleaseError:function(e){t.log("OnReleaseError",e),n.trackCustomEvent("trackError",{error:"errorlog|videoError|5xx|video_failed"},"logError"),this._super(e)},_comscoreTracking:function(){var e="",t="",i="";e=document.location.href,t=document.referrer,i=document.title,("undefined"==typeof e||"null"==e)&&(e=""),("undefined"==typeof t||"null"==t)&&(t=""),("undefined"==typeof i||"null"==i)&&(i=""),null!=e&&e.length>512&&(e=e.substr(0,512)),t.length>512&&(t=t.substr(0,512));var a=["https:"==document.location.protocol?"https://sb":"http://b",".scorecardresearch.com/p","?c1=","1","&c2=",escape(this.config.tracking.comscore_id),"&c3=",escape(""),"&c4=",escape(this.config.tracking.comscore_sect_id),"&c5=",escape(this.videoType),"&c6=",escape(""),"&c10=",escape("1-1"),"&c7=",escape(e),"&c8=",escape(i),"&c9=",escape(t),"&rn=",Math.random(),"&cv=2.0"].join("");a.length>2080&&(a=a.substr(0,2080)),comImg="",comImg=new Image,comImg.src=a},_nielsenTracking:function(){var e,t=Math.ceil(1e9*Math.random());e="http://secure-us.imrworldwide.com/cgi-bin/m?ci="+this.config.tracking.nielsen_cid,e+="&tl=dav0-"+escape(this.video.title),this.isAd&&(e+="&c3=st,a"+escape("StreamType")),e+="&c6=vc,"+this.config.tracking.nielsen_vcid+escape(""),e+="&cc=1",e+="&rnd="+t,davImg="",davImg=new Image,davImg.src=e},updateVideo:function(e){t.log("updateVideo",e);for(var i={},a=e.data.baseClips,n=0;n<a.length;n++)if(a[n].isAd===!1&&this.video.mpxRefId!=a[n].guid){t.log("updateVideo: video changed. set new data"),i.title=e.data.title||a[n].title,i.mpxRefId=a[n].guid,i.mpxId=a[n].contentID,i.id=null,i.primaryTopic={id:null},this.video=i;break}},_updateVideoInfoHtml:function(){if(this.options.vidInfoContainer){var e=this.$element.parents(this.options.vidInfoContainer);try{e.find("[data-video-info-title]").text(this.video.title||""),e.find("[data-video-info-description]").text(this.video.description||""),e.find("[data-video-info-author").text(this.video.author.firstName||" "+this.video.author.lastName||""),e.find("[data-video-info-collection").text(this.video.primaryCollection.title||"")}catch(t){}}},_onReleaseStart:function(i){t.log("onReleaseStart",i),this._relayEvent("onReleaseStart",i),e("#fastLoadStill").remove(),this.playNewRelease=!1,this.unpause(),this.updateVideo(i),this._updateVideoInfoHtml(),this.initTrackingData(),this.trackPerformanceEvent("releasestart")},_onReleaseEnd:function(e){t.log("onReleaseEnd",e),this._relayEvent("onReleaseEnd",this.video)},_onReleaseSelected:function(e){t.log("OnReleaseSelected",e),this.trackPerformanceEvent("releaselected")},_onPlayerLoaded:function(e){t.log("onPlayerLoaded",e),this._relayEvent("onPlayerLoaded",e),this.trackPerformanceEvent("playerloaded"),this.trackPerformanceEvent("playerloaded"+this.runtime.toLowerCase()),$pdk.controller.setSubtitleStyle({globalDataType:"com.theplatform.pdk.data::SubtitleStyle",fontSize:.6,textAlign:"left"},[this.instance]),this.checkFlashCrashed()},_onShowPlayOverlay:function(e){t.log("_onShowPlayOverlay",e),this._relayEvent("onShowPlayOverlay",e),this.readyToPlay=!0,e.data===!0&&this.trackPerformanceEvent("showplayoverlay"),this._lazyLoadImages()},_onPlayButtonClicked:function(i){if(t.log("_onPlayButtonClicked",i),!this.trackPlayButtonClick)return t.log("_onPlayButtonClicked: do not track"),void(this.trackPlayButtonClick=!0);i.data===!0&&this.trackPerformanceEvent("playclick");var a=e("[data-cnet-video-options]",self.$element).data("cnetVideoOptions"),o={};a&&a.videos&&a.videos.length>0&&(o.videoTitle=a.videos[0].title||a.videos[0].headline,o.videoId=a.videos[0].mpxRefId),t.log("videoTrackingData",o),n.trackVideo("playButtonOverlayClick",0,o)},_onPdkTrace:function(e){},_onRefreshReleaseModel:function(e){t.log("onRefreshReleaseModel",e),this.playNewRelease&&(t.log("playNewRelease: "+this.playNewRelease),t.log(e),t.log("playNext"),$pdk.controller.playNext(!0,!1,[this.instance]),this.playNewRelease=!1)},_relayEvent:function(i,a){t.log("relayEvent: "+i),t.log(a),this.options.timelineContainer&&e(this.options.timelineContainer).trigger(i,[a]),this._trigger(i,[a])},_isAd:function(e){var i=null;return e&&e.data&&e.data.baseClip&&(i=e.data.baseClip.isAd,t.log("_isAd () evt.data.baseClip.isAd",i)),i},findPid:function(){var e=this.video.files.hasOwnProperty("data")?this.video.files.data:this.video.files;return this.useHdsMedia()?e.hds:void 0===e[this.feedId]?e.wifi||e["3g"]:e[this.feedId]},useHdsMedia:function(){return"rtmp"==this.feedId&&null!=this.video.files.hds},playNextVideo:function(){if(this.options.videos&&this.playNewRelease===!1&&this.autoPlayNext===!0&&(this.autoPlayNext=!1,this.options.videos.length>1)){var e=this.options.videos.shift();this.options.videos.push(e),this.pause(),this.playVideo(e)}},displayAlert:function(i,a){e('[data-item="loadingCircle"]',this.$element).remove(),this.$element.append('<div class="videoBlocked"><div class="blocked"></div><p class="title">'+i+'</p><p class="message">'+a+"</p></div>"),t.log("displayAlert() - Ad block message displayed to user.")},hasFlash:function(){var e=!1;try{var t=new ActiveXObject("ShockwaveFlash.ShockwaveFlash");t&&(e=!0)}catch(i){navigator.mimeTypes&&void 0!==navigator.mimeTypes["application/x-shockwave-flash"]&&navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin&&(e=!0)}return e},checkFlashCrashed:function(){if("Flash"==this.runtime){var t=!0;try{var i=e("#"+this.instance+" object");i.length>0&&"undefined"==typeof i[0].SetVariable&&(t=!1)}catch(a){}t?window.setTimeout(e.proxy(this.checkFlashCrashed,this),1e3):this.trackPerformanceEvent("flashfailed")}},getFlashDescription:function(){var e="No Flash";if(navigator.plugins&&navigator.mimeTypes.length)e=navigator.plugins["Shockwave Flash"],e&&e.description&&(e=e.description);else if(window.navigator.userAgent.indexOf("MSIE "))try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(t){}return e},getVideoInfo:function(){var e=this.video;return delete e.author,delete e.chapters,delete e.files,delete e.primaryTopic,delete e.primaryCollection,e.browser=window.navigator.userAgent,e.pageUrl=document.location.href,e.flash=this.getFlashDescription(),JSON.stringify(e)},_lazyLoadImages:function(){t.log("lazyLoadImages"),e("img.lazy").lazyload({failure_limit:2e3,skip_invisible:!1,threshold:200})},trackPerformanceEvent:function(i){try{var a={event:"log",pageurl:document.location.href,siteid:o.tracking.data._siteId,mapp:"cnetvideotrack",v12:o.tracking.data.siteEdition,v13:(o.tracking.data.testName?o.tracking.data.testName:"")+"|"+(o.tracking.data.testVersion?o.tracking.data.testVersion:"")+"|"+(o.tracking.data.testGroup?o.tracking.data.testGroup:""),v16:o.guid,v17:o.tracking.data.topicId.toString(),v18:o.tracking.data.articleId,v19:o.tracking.data.pageType,v20:o.tracking.data._articleType?o.tracking.data._articleType:o.tracking.data.articleType,v21:o.tracking.data._siteTypeDevice,v23:o.tracking.data._sitePrimaryRsid,objnm:this.options.video.mpxRefId,rsid:o.tracking.data.dwAccount,riaevent:i},n=(new Image).src="http://dw.cbsi.com/levt/ria/e.gif?"+e.param(a);t.log("trackPerformanceEvent: "+i),t.log("trackPerformanceEvent",a),t.log("trackPerformanceEvent",n)}catch(s){t.log("trackPerformanceEvent: not tracked. Missing required param.")}try{void 0===performance.getEntriesByName(i)[0]&&performance.mark("video_"+i)}catch(s){}try{var r=0;(void 0===mpulseUserTiming[i]||0===mpulseUserTiming[i])&&(mpulseUserTiming[i]=performance.now(),r=1);var l={showplayoverlay:["showoverl","playerloaded"],cnetvideocreate:["create"],playerloaded:["ploaded","initpdk"],contentstart:["cstart","adend"],releaselected:["releasele","playerloaded"],adstart:["adStart","releaselected"],initpdk:["initpdk","cnetvideocreate"]},d=l[i][0];if(d){"undefined"!=typeof BOOMR&&mPulseApp.getSessionID()!==BOOMR.session.ID&&mPulseApp.setSessionID(BOOMR.session.ID),mPulseApp.setPageGroup(o.tracking.data.soastaPageType),mPulseApp.setABTest(o.tracking.data.soastaBucket);var c=mpulseUserTiming[i];if(e.isArray(l[i])){var h=mpulseUserTiming[l[i][1]]?mpulseUserTiming[l[i][1]]:0;c=mpulseUserTiming[i+"_from_"+l[i][1]]=mpulseUserTiming[i]-h}r&&mPulseApp.sendTimer("video_"+d,mpulseUserTiming[i])}}catch(s){t.log("Error tracking"+i+": "+s)}},trackAction:function(e){n.trackCustomEvent("carousel",{levtType:"ria",event:"log",mapp:"reviews4505",comp:"cnetVideo",comptyp:e,clickGenericText:e,riaevent:"click",pageType:o.tracking.data.pageType,siteEdition:o.tracking.data.siteEdition,siteType:o.tracking.data.siteType,deviceType:o.tracking.data.deviceType,siteSection:o.tracking.data.siteSection,_pageChannelType:o.tracking.data._pageChannelType,articleId:o.tracking.data.articleId,articleTitle:o.tracking.data.articleTitle,articleType:o.tracking.data.articleType,siteHier:o.tracking.data.siteHier,_pageTitle:o.tracking.data._pageTitle},"trackClick")},clickPlayButton:function(e){if(t.log("clickPlayButton: ready? "+this.readyToPlay+", track? "+e),this.readyToPlay)return e=null!=e?e:!0,this.trackPlayButtonClick=e,$pdk.controller.clickPlayButton([this.instance]),!0;var i=this;return window.setTimeout(function(){i.clickPlayButton(e)},100),!1},getSharingSiteKeys:function(){var t=e.map(this.sharingSites,function(e,t){return t});return t},getSharingSiteOptions:function(i){if(this.sharingSites[i]){var a=e.map(this.sharingSites[i],function(e,t){return"icon"==t?o.video.tpBaseUrl+"/"+e:e});return t.log(a),a.join("|")}return null},_setupPopOnScroll:function(){l.isDesktopUserAgent()&&(this.autoplayControlEnabled="on"==d.read("autoplayEnabled"));var e=this,t=this.$element.closest('[data-pop-on-scroll="placeholder"]'),i=this.$element.find('[data-pop-on-scroll="drag"]'),a=this.$element.find('[data-pop-on-scroll="close"]');t.length>0&&(this.popOutWaypoint=new Waypoint({element:t,handler:function(t){"up"===t&&e.poppedOut&&(e.$element.removeClass("popOut").addClass("stayPut"),e.trackAction("scroll-video-pop-in"),e.poppedOut=!1),(e.isPlaying||e.playbackNotStarted&&this.autoplayControlEnabled)&&("down"!==t||e.poppedOut||(e.$element.removeClass("stayPut").addClass("popOut"),e.trackAction("scroll-video-pop-out"),e.poppedOut=!0))},offset:e.options.popOutOffset})),i.length>0&&this.$element.draggable({handle:i,stop:function(t){e.trackAction("drag-video")}}),a.on("click",function(t){e.pause(),e.$element.removeClass("popOut").addClass("stayPut"),e.trackAction("close-scroll-video")})},initPopOut:function(){var t=e('[data-pop-on-scroll="placeholder"]').offset().top-e(window).scrollTop();this.options.popOnScroll&&t<this.options.popOutOffset&&(this.$element.removeClass("stayPut").addClass("popOut"),this.trackAction("scroll-video-pop-out"),this.poppedOut=!0)}})});